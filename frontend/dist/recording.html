<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recording...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: transparent;
            overflow: hidden;
        }

        .container {
            background: #1a1a1a;
            border-radius: 20px;
            padding: 20px 24px;
            width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid #2a2a2a;
        }

        .top-section {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .recording-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dot {
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }

        .model-selector {
            position: relative;
            flex: 1;
        }

        .model-dropdown {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 8px 12px;
            color: #e0e0e0;
            font-size: 14px;
            cursor: pointer;
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }

        .model-dropdown:hover {
            background: #333;
            border-color: #4a4a4a;
        }

        .model-dropdown:focus {
            border-color: #3b82f6;
        }

        .visualizer-container {
            background: #0a0a0a;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 3px;
        }

        .visualizer-bar {
            width: 4px;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 2px;
            transition: height 0.1s ease;
            height: 4px;
            min-height: 4px;
        }

        .buttons {
            display: flex;
            gap: 12px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .stop-btn {
            background: #3b82f6;
            color: white;
        }

        .stop-btn:hover {
            background: #2563eb;
        }

        .cancel-btn {
            background: #2a2a2a;
            color: #999;
            border: 1px solid #3a3a3a;
        }

        .cancel-btn:hover {
            background: #333;
            border-color: #4a4a4a;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-section">
            <div class="recording-indicator">
                <div class="dot"></div>
            </div>
            <div class="model-selector">
                <select class="model-dropdown" id="modelSelect">
                    <option value="tiny">Tiny (Fastest)</option>
                    <option value="base">Base (Fast)</option>
                    <option value="small" selected>Small (Balanced)</option>
                    <option value="medium">Medium (Accurate)</option>
                    <option value="large-v3">Large V3 (Best)</option>
                </select>
            </div>
        </div>
        <div class="visualizer-container" id="visualizer">
            <!-- Bars will be created dynamically -->
        </div>
        <div class="buttons">
            <button class="stop-btn" onclick="stopRecording()">Stop</button>
            <button class="cancel-btn" onclick="cancelRecording()">Cancel</button>
        </div>
    </div>

    <script>
        const BACKEND_URL = 'http://127.0.0.1:8000';
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let animationId = null;
        let bars = [];

        // Initialize visualizer bars
        function initVisualizer() {
            const visualizer = document.getElementById('visualizer');
            const barCount = 60;

            for (let i = 0; i < barCount; i++) {
                const bar = document.createElement('div');
                bar.className = 'visualizer-bar';
                visualizer.appendChild(bar);
                bars.push(bar);
            }
        }

        // Start audio monitoring
        async function startAudioMonitoring() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                analyser.fftSize = 128;
                microphone.connect(analyser);

                updateVisualizer();
                console.log('✅ Audio monitoring started');
            } catch (error) {
                console.error('❌ Audio monitoring error:', error);
            }
        }

        // Update visualizer animation
        function updateVisualizer() {
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // Update each bar
            bars.forEach((bar, index) => {
                const dataIndex = Math.floor(index * dataArray.length / bars.length);
                const value = dataArray[dataIndex];
                const height = Math.max(4, (value / 255) * 60);
                bar.style.height = `${height}px`;
            });

            animationId = requestAnimationFrame(updateVisualizer);
        }

        // Stop audio monitoring
        function stopAudioMonitoring() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (microphone) {
                microphone.disconnect();
            }
            if (audioContext) {
                audioContext.close();
            }
        }

        // Stop and transcribe
        async function stopRecording() {
            console.log('🛑 Stop button clicked');
            stopAudioMonitoring();

            try {
                const response = await fetch(`${BACKEND_URL}/stop`, { method: 'POST' });
                const data = await response.json();

                if (data.status === 'success' && data.text) {
                    console.log('✅ Transcription:', data.text);

                    // Inject text
                    const { invoke } = window.__TAURI_INTERNALS__;
                    await invoke('inject_text_directly', { text: data.text });
                }
            } catch (error) {
                console.error('❌ Stop error:', error);
            }

            // Hide window
            const { webviewWindow } = window.__TAURI_INTERNALS__;
            await webviewWindow.getCurrent().hide();
            console.log('✅ Window hidden');
        }

        // Cancel recording
        async function cancelRecording() {
            console.log('❌ Cancel button clicked');
            stopAudioMonitoring();

            try {
                await fetch(`${BACKEND_URL}/cancel`, { method: 'POST' });
            } catch (error) {
                console.error('❌ Cancel error:', error);
            }

            // Hide window
            const { webviewWindow } = window.__TAURI_INTERNALS__;
            await webviewWindow.getCurrent().hide();
            console.log('✅ Window hidden');
        }

        // Model selection handler
        document.getElementById('modelSelect').addEventListener('change', async (e) => {
            const model = e.target.value;
            console.log('📝 Model selected:', model);

            // Send to backend via Tauri command
            const { invoke } = window.__TAURI_INTERNALS__;
            try {
                await invoke('set_model_and_device', {
                    model: model,
                    device: 'auto'
                });
                console.log('✅ Model updated');
            } catch (error) {
                console.error('❌ Model update error:', error);
            }
        });

        // Escape key cancels
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                e.preventDefault();
                cancelRecording();
            }
        });

        // Initialize on load
        initVisualizer();
        console.log('✅ Recording window loaded');

        // Check if window is visible and start monitoring
        async function checkAndStartMonitoring() {
            const { webviewWindow } = window.__TAURI_INTERNALS__;
            const currentWindow = webviewWindow.getCurrent();
            const isVisible = await currentWindow.isVisible();

            if (isVisible && !audioContext) {
                await startAudioMonitoring();
            }
        }

        // Poll visibility every 500ms to start/stop monitoring
        setInterval(async () => {
            const { webviewWindow } = window.__TAURI_INTERNALS__;
            const currentWindow = webviewWindow.getCurrent();
            const isVisible = await currentWindow.isVisible();

            if (isVisible && !audioContext) {
                await startAudioMonitoring();
            } else if (!isVisible && audioContext) {
                stopAudioMonitoring();
            }
        }, 500);
    </script>
</body>
</html>
